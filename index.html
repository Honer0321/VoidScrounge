<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素风格Tileset生成器 - 布局优化版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #34495e;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #1abc9c;
            text-shadow: 2px 2px 0 #16a085;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #bdc3c7;
        }
        
        .performance-warning {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .tool-section {
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .canvas-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            width: 100%;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #3498db;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c3e50;
        }
        
        h3 {
            font-size: 1.3rem;
            margin: 20px 0 15px;
            color: #f1c40f;
        }
        
        .tools-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .tool-group {
            flex: 1;
            min-width: 200px;
            background: #2c3e50;
            padding: 15px;
            border-radius: 8px;
        }
        
        .tools {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .tool {
            padding: 12px;
            background: #34495e;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .tool:hover {
            background: #3498db;
            transform: translateY(-3px);
        }
        
        .tool.active {
            background: #1abc9c;
            box-shadow: 0 0 0 3px #16a085;
        }
        
        .terrain-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .terrain {
            height: 35px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        
        .terrain.active {
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .terrain-color {
            width: 100%;
            height: 100%;
            border-radius: 3px;
        }
        
        .color-picker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        #grass .terrain-color { background: #27ae60; }
        #water .terrain-color { background: #2980b9; }
        #sand .terrain-color { background: #e67e22; }
        #stone .terrain-color { background: #95a5a6; }
        #dirt .terrain-color { background: #8B4513; }
        #snow .terrain-color { background: #ecf0f1; }
        
        .canvas-container {
            background: #1a2530;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            max-width: 100%;
        }
        
        #pixelCanvas {
            background-image: 
                linear-gradient(45deg, #2c3e50 25%, transparent 25%),
                linear-gradient(-45deg, #2c3e50 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #2c3e50 75%),
                linear-gradient(-45deg, transparent 75%, #2c3e50 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #16a085;
            border-radius: 5px;
            margin-bottom: 20px;
            image-rendering: pixelated;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            max-width: 100%;
        }
        
        .export-btn {
            background: #1abc9c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .export-btn:hover {
            background: #16a085;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #d35400;
        }
        
        .btn-info {
            background: #3498db;
        }
        
        .btn-info:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .settings-group {
            background: #2c3e50;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .settings-label {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .settings-input {
            flex: 2;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #34495e;
            background: #ecf0f1;
            font-size: 0.9rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: block;
            padding: 8px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.3s;
            font-size: 0.9rem;
        }
        
        .file-label:hover {
            background: #2980b9;
        }
        
        .instructions {
            margin-top: 30px;
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .instructions h2 {
            color: #f1c40f;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-top: 15px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #bdc3c7;
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #2ecc71;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .compression-info {
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-top: 10px;
            text-align: center;
        }
        
        .upload-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .upload-option {
            padding: 8px;
            background: #2c3e50;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9rem;
        }
        
        .upload-option:hover {
            background: #3498db;
        }
        
        .upload-option.active {
            background: #1abc9c;
            box-shadow: 0 0 0 2px #16a085;
        }
        
        .export-names {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-name-label {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .export-name-input {
            flex: 2;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #34495e;
            background: #ecf0f1;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .tools-container {
                flex-direction: column;
            }
            
            .tool-group {
                min-width: 100%;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal h3 {
            margin-top: 0;
            color: #f1c40f;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .canvas-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>像素风格Tileset生成器</h1>
            <p class="subtitle">创建您自己的像素艺术地形素材 | 支持图片上传和自定义导出名称</p>
        </header>
        
        <div class="performance-warning" id="performanceWarning">
            <strong>性能提示：</strong> 大画布可能会影响性能，请考虑使用较小的像素尺寸或减少绘制操作。
        </div>
        
        <div class="main-content">
            <section class="tool-section">
                <div class="tools-container">
                    <div class="tool-group">
                        <h3>工具</h3>
                        <div class="tools">
                            <div class="tool active" id="drawTool">绘制</div>
                            <div class="tool" id="eraseTool">擦除</div>
                        </div>
                        
                        <h3>地形类型</h3>
                        <div class="terrain-types">
                            <div class="terrain active" id="grass" title="草地">
                                <div class="terrain-color"></div>
                                <input type="color" class="color-picker" value="#27ae60">
                            </div>
                            <div class="terrain" id="water" title="水域">
                                <div class="terrain-color"></div>
                                <input type="color" class="color-picker" value="#2980b9">
                            </div>
                            <div class="terrain" id="sand" title="沙地">
                                <div class="terrain-color"></div>
                                <input type="color" class="color-picker" value="#e67e22">
                            </div>
                            <div class="terrain" id="stone" title="石地">
                                <div class="terrain-color"></div>
                                <input type="color" class="color-picker" value="#95a5a6">
                            </div>
                            <div class="terrain" id="dirt" title="泥土">
                                <div class="terrain-color"></div>
                                <input type="color" class="color-picker" value="#8B4513">
                            </div>
                            <div class="terrain" id="snow" title="雪地">
                                <div class="terrain-color"></div>
                                <input type="color" class="color-picker" value="#ecf0f1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>图片上传</h3>
                        <div class="settings-group">
                            <label for="uploadImage" class="file-label">选择图片 (PNG/JPG)</label>
                            <input type="file" id="uploadImage" class="file-input" accept="image/png, image/jpeg">
                            
                            <div class="upload-options">
                                <div class="upload-option active" id="optionReplace">替换画布</div>
                                <div class="upload-option" id="optionOverlay">叠加到画布</div>
                            </div>
                            
                            <button id="processImageBtn" class="export-btn btn-success" style="width: 100%; margin-top: 10px;">处理并应用图片</button>
                        </div>
                        
                        <h3>导出名称</h3>
                        <div class="export-names">
                            <div class="export-name-row">
                                <span class="export-name-label">项目名称:</span>
                                <input type="text" id="projectName" class="export-name-input" value="pixel-art-project">
                            </div>
                            <div class="export-name-row">
                                <span class="export-name-label">PNG名称:</span>
                                <input type="text" id="pngName" class="export-name-input" value="pixel-tileset">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3>画布设置</h3>
                        <div class="settings-group">
                            <div class="settings-row">
                                <label class="settings-label" for="canvasWidth">宽度:</label>
                                <input type="number" id="canvasWidth" class="settings-input" min="100" max="2000" value="800">
                            </div>
                            <div class="settings-row">
                                <label class="settings-label" for="canvasHeight">高度:</label>
                                <input type="number" id="canvasHeight" class="settings-input" min="100" max="2000" value="800">
                            </div>
                            <div class="settings-row">
                                <label class="settings-label" for="pixelSize">像素大小:</label>
                                <input type="number" id="pixelSize" class="settings-input" min="2" max="50" value="10">
                            </div>
                            <button id="applyCanvasSettings" class="export-btn btn-warning" style="width: 100%; margin-top: 10px;">应用设置</button>
                        </div>
                        
                        <h3>性能选项</h3>
                        <div class="settings-group">
                            <div class="settings-row">
                                <label class="settings-label" for="gridToggle">显示网格:</label>
                                <input type="checkbox" id="gridToggle" checked>
                            </div>
                            <div class="settings-row">
                                <label class="settings-label" for="optimizedDrawing">优化性能:</label>
                                <input type="checkbox" id="optimizedDrawing" checked>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;">
                    <button id="saveProjectBtn" class="export-btn btn-info">保存项目</button>
                    <label for="loadProject" class="file-label">加载项目</label>
                    <input type="file" id="loadProject" class="file-input" accept=".json">
                    <button id="clearBtn" class="export-btn btn-danger">清空画布</button>
                    <button id="exportBtn" class="export-btn">导出PNG</button>
                </div>
                
                <div class="compression-info" id="compressionInfo">
                    使用高效压缩算法，文件大小减少约 80%
                </div>
            </section>
            
            <section class="canvas-section">
                <div class="canvas-container">
                    <h2>画布预览 <span id="canvasSizeInfo">(800×800)</span></h2>
                    <canvas id="pixelCanvas"></canvas>
                    <div class="canvas-controls">
                        <button id="zoomInBtn" class="export-btn">放大</button>
                        <button id="zoomOutBtn" class="export-btn">缩小</button>
                        <button id="resetViewBtn" class="export-btn">重置视图</button>
                    </div>
                </div>
            </section>
        </div>
        
        <section class="instructions">
            <h2>使用说明</h2>
            <ul>
                <li>选择绘制工具和地形类型，然后在画布上点击或拖动来绘制像素</li>
                <li>使用擦除工具可以清除像素（设置为透明）</li>
                <li>点击地形块上的颜色选择器可以自定义颜色</li>
                <li>上传PNG或JPG图片可以将其转换为像素画</li>
                <li>选择"替换画布"会清空当前画布并用图片替换</li>
                <li>选择"叠加到画布"会将图片叠加到现有画布上</li>
                <li>可以自定义项目名称和PNG导出名称</li>
                <li>调整画布设置后点击"应用设置"按钮生效</li>
                <li>使用放大、缩小和重置视图按钮调整画布显示</li>
                <li>使用"保存项目"按钮将当前画布保存为JSON文件（已压缩）</li>
                <li>使用"加载项目"按钮导入之前保存的项目继续编辑</li>
                <li>清空画布按钮可以重置整个画布</li>
                <li>完成设计后，点击导出按钮保存为PNG图像（支持透明背景）</li>
                <li>导出的素材可以用于游戏开发或图形设计项目</li>
            </ul>
        </section>
        
        <footer>
            <p>© 2023 像素风格Tileset生成器 | 使用HTML5 Canvas技术</p>
        </footer>
    </div>

    <div class="notification" id="notification">操作成功！</div>

    <div class="modal" id="resizeModal">
        <div class="modal-content">
            <h3>调整画布尺寸</h3>
            <p>上传的图片尺寸与当前画布不匹配。您希望如何调整？</p>
            <div class="modal-buttons">
                <button id="resizeToImage" class="export-btn btn-info">调整画布适应图片</button>
                <button id="resizeImageToCanvas" class="export-btn btn-warning">调整图片适应画布</button>
                <button id="cancelResize" class="export-btn btn-danger">取消</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('pixelCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const notification = document.getElementById('notification');
            const compressionInfo = document.getElementById('compressionInfo');
            const performanceWarning = document.getElementById('performanceWarning');
            const canvasSizeInfo = document.getElementById('canvasSizeInfo');
            const resizeModal = document.getElementById('resizeModal');
            const projectNameInput = document.getElementById('projectName');
            const pngNameInput = document.getElementById('pngName');
            
            // 默认设置
            let canvasWidth = 800;
            let canvasHeight = 800;
            let pixelSize = 10;
            let zoomLevel = 1.0;
            let showGrid = true;
            let optimizedDrawing = true;
            let uploadMode = 'replace'; // 'replace' or 'overlay'
            let uploadedImage = null;
            
            let isDrawing = false;
            let selectedTool = 'draw';
            let selectedTerrain = 'grass';
            let terrainColors = {
                'grass': '#27ae60',
                'water': '#2980b9',
                'sand': '#e67e22',
                'stone': '#95a5a6',
                'dirt': '#8B4513',
                'snow': '#ecf0f1'
            };
            
            // 显示通知
            function showNotification(message, isError = false) {
                notification.textContent = message;
                notification.className = isError ? 'notification error show' : 'notification show';
                
                setTimeout(() => {
                    notification.className = 'notification';
                }, 3000);
            }
            
            // 显示模态框
            function showModal() {
                resizeModal.style.display = 'flex';
            }
            
            // 隐藏模态框
            function hideModal() {
                resizeModal.style.display = 'none';
            }
            
            // 检查性能并显示警告
            function checkPerformance() {
                const totalPixels = (canvasWidth / pixelSize) * (canvasHeight / pixelSize);
                if (totalPixels > 10000) {
                    performanceWarning.style.display = 'block';
                } else {
                    performanceWarning.style.display = 'none';
                }
                
                canvasSizeInfo.textContent = `(${canvasWidth}×${canvasHeight})`;
            }
            
            // 初始化画布
            function initCanvas() {
                // 设置画布尺寸
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                
                // 应用缩放
                canvas.style.width = (canvasWidth * zoomLevel) + 'px';
                canvas.style.height = (canvasHeight * zoomLevel) + 'px';
                
                // 清除画布为透明
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制网格（仅用于视觉参考，不会导出）
                if (showGrid) {
                    drawGrid();
                }
                
                checkPerformance();
            }
            
            // 绘制网格
            function drawGrid() {
                ctx.strokeStyle = 'rgba(52, 73, 94, 0.3)';
                ctx.lineWidth = 1;
                
                // 优化网格绘制 - 只绘制可见区域的网格
                for (let x = 0; x <= canvas.width; x += pixelSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y <= canvas.height; y += pixelSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }
            
            // 获取颜色
            function getColorForTerrain(terrain) {
                return terrainColors[terrain] || '#27ae60';
            }
            
            // 绘制像素
            function drawPixel(x, y) {
                const pixelX = Math.floor(x / pixelSize) * pixelSize;
                const pixelY = Math.floor(y / pixelSize) * pixelSize;
                
                if (selectedTool === 'draw') {
                    ctx.fillStyle = getColorForTerrain(selectedTerrain);
                    ctx.fillRect(pixelX, pixelY, pixelSize, pixelSize);
                } else if (selectedTool === 'erase') {
                    // 擦除：清除这个区域（变为透明）
                    ctx.clearRect(pixelX, pixelY, pixelSize, pixelSize);
                }
                
                // 重绘网格（在透明区域上重新绘制网格线）
                if (showGrid) {
                    drawGrid();
                }
            }
            
            // 更新画布设置
            function updateCanvasSettings() {
                const newWidth = parseInt(document.getElementById('canvasWidth').value);
                const newHeight = parseInt(document.getElementById('canvasHeight').value);
                const newPixelSize = parseInt(document.getElementById('pixelSize').value);
                
                // 验证输入
                if (isNaN(newWidth) || newWidth < 100 || newWidth > 2000) {
                    showNotification('宽度必须在100-2000像素之间', true);
                    return;
                }
                
                if (isNaN(newHeight) || newHeight < 100 || newHeight > 2000) {
                    showNotification('高度必须在100-2000像素之间', true);
                    return;
                }
                
                if (isNaN(newPixelSize) || newPixelSize < 2 || newPixelSize > 50) {
                    showNotification('像素大小必须在2-50之间', true);
                    return;
                }
                
                canvasWidth = newWidth;
                canvasHeight = newHeight;
                pixelSize = newPixelSize;
                
                // 更新性能优化选项
                showGrid = document.getElementById('gridToggle').checked;
                optimizedDrawing = document.getElementById('optimizedDrawing').checked;
                
                initCanvas();
                showNotification('画布设置已应用');
            }
            
            // 处理上传的图片
            function processUploadedImage() {
                if (!uploadedImage) {
                    showNotification('请先选择图片', true);
                    return;
                }
                
                const img = new Image();
                img.onload = function() {
                    // 检查图片尺寸是否与画布匹配
                    if (img.width !== canvasWidth || img.height !== canvasHeight) {
                        // 显示尺寸不匹配提示
                        showModal();
                    } else {
                        // 尺寸匹配，直接处理
                        applyImageToCanvas(img);
                    }
                };
                img.src = uploadedImage;
            }
            
            // 将图片应用到画布
            function applyImageToCanvas(img, resizeCanvas = false) {
                if (resizeCanvas) {
                    // 调整画布尺寸以适应图片
                    canvasWidth = img.width;
                    canvasHeight = img.height;
                    
                    // 更新UI
                    document.getElementById('canvasWidth').value = canvasWidth;
                    document.getElementById('canvasHeight').value = canvasHeight;
                    
                    initCanvas();
                }
                
                // 创建临时canvas处理图片
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvasWidth;
                tempCanvas.height = canvasHeight;
                const tempCtx = tempCanvas.getContext('2d');
                
                // 绘制图片到临时canvas（适应画布尺寸）
                tempCtx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                
                // 获取图片数据
                const imageData = tempCtx.getImageData(0, 0, canvasWidth, canvasHeight);
                const data = imageData.data;
                
                // 根据上传模式处理画布
                if (uploadMode === 'replace') {
                    // 清空画布
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                
                // 将图片转换为像素画
                for (let y = 0; y < canvasHeight; y += pixelSize) {
                    for (let x = 0; x < canvasWidth; x += pixelSize) {
                        // 获取当前像素块的中心点颜色
                        const pixelIndex = ((y + Math.floor(pixelSize/2)) * canvasWidth + (x + Math.floor(pixelSize/2))) * 4;
                        
                        const r = data[pixelIndex];
                        const g = data[pixelIndex + 1];
                        const b = data[pixelIndex + 2];
                        const a = data[pixelIndex + 3];
                        
                        // 如果像素不是完全透明的，则绘制
                        if (a > 0) {
                            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${a/255})`;
                            ctx.fillRect(x, y, pixelSize, pixelSize);
                        }
                    }
                }
                
                // 重绘网格
                if (showGrid) {
                    drawGrid();
                }
                
                showNotification('图片已成功应用到画布');
            }
            
            // 将图像数据编码为紧凑格式
            function encodeImageData(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                // 使用RLE（Run-Length Encoding）压缩
                let encoded = [];
                let currentColor = null;
                let count = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];
                    
                    // 如果是透明像素
                    if (a === 0) {
                        if (currentColor === 'transparent') {
                            count++;
                        } else {
                            if (currentColor !== null) {
                                encoded.push(currentColor, count);
                            }
                            currentColor = 'transparent';
                            count = 1;
                        }
                    } else {
                        // 将颜色转换为十六进制字符串
                        const color = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                        
                        if (currentColor === color) {
                            count++;
                        } else {
                            if (currentColor !== null) {
                                encoded.push(currentColor, count);
                            }
                            currentColor = color;
                            count = 1;
                        }
                    }
                }
                
                // 添加最后一个颜色段
                if (currentColor !== null) {
                    encoded.push(currentColor, count);
                }
                
                return {
                    width: width,
                    height: height,
                    data: encoded.join(',')
                };
            }
            
            // 解码图像数据
            function decodeImageData(encodedData) {
                const width = encodedData.width;
                const height = encodedData.height;
                const data = encodedData.data.split(',');
                
                const imageData = ctx.createImageData(width, height);
                const pixels = imageData.data;
                
                let pixelIndex = 0;
                
                for (let i = 0; i < data.length; i += 2) {
                    const color = data[i];
                    const count = parseInt(data[i + 1]);
                    
                    for (let j = 0; j < count; j++) {
                        if (color === 'transparent') {
                            pixels[pixelIndex] = 0;     // R
                            pixels[pixelIndex + 1] = 0; // G
                            pixels[pixelIndex + 2] = 0; // B
                            pixels[pixelIndex + 3] = 0; // A
                        } else {
                            // 解析十六进制颜色
                            const r = parseInt(color.substring(1, 3), 16);
                            const g = parseInt(color.substring(3, 5), 16);
                            const b = parseInt(color.substring(5, 7), 16);
                            
                            pixels[pixelIndex] = r;     // R
                            pixels[pixelIndex + 1] = g; // G
                            pixels[pixelIndex + 2] = b; // B
                            pixels[pixelIndex + 3] = 255; // A
                        }
                        
                        pixelIndex += 4;
                    }
                }
                
                return imageData;
            }
            
            // 保存项目
            function saveProject() {
                // 获取项目名称
                let projectName = projectNameInput.value.trim();
                if (!projectName) {
                    projectName = "pixel-art-project";
                    projectNameInput.value = projectName;
                }
                
                // 获取画布数据
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // 编码图像数据
                const encodedData = encodeImageData(imageData);
                
                // 创建项目数据对象
                const projectData = {
                    version: '2.0',
                    canvasWidth: canvasWidth,
                    canvasHeight: canvasHeight,
                    pixelSize: pixelSize,
                    encodedImageData: encodedData,
                    terrainColors: terrainColors
                };
                
                // 转换为JSON字符串
                const jsonData = JSON.stringify(projectData);
                
                // 计算压缩率
                const originalSize = imageData.data.length * 2; // 近似值
                const compressedSize = new Blob([jsonData]).size;
                const compressionRatio = Math.round((1 - compressedSize / originalSize) * 100);
                
                compressionInfo.textContent = `使用高效压缩算法，文件大小减少约 ${compressionRatio}%`;
                
                // 创建下载链接
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${projectName}.json`;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showNotification('项目已保存（已压缩）');
            }
            
            // 导出为PNG
            function exportPNG() {
                // 获取PNG名称
                let pngName = pngNameInput.value.trim();
                if (!pngName) {
                    pngName = "pixel-tileset";
                    pngNameInput.value = pngName;
                }
                
                // 创建临时canvas用于导出（不包含网格）
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = canvas.width;
                exportCanvas.height = canvas.height;
                const exportCtx = exportCanvas.getContext('2d');
                
                // 复制图像数据
                exportCtx.putImageData(ctx.getImageData(0, 0, canvas.width, canvas.height), 0, 0);
                
                // 导出为PNG
                const dataURL = exportCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${pngName}.png`;
                link.href = dataURL;
                link.click();
                
                showNotification('图像已导出为PNG');
            }
            
            // 加载项目
            function loadProject(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        
                        // 验证数据
                        if (!projectData.version || !projectData.canvasWidth || !projectData.encodedImageData) {
                            throw new Error('无效的项目文件格式');
                        }
                        
                        // 更新画布设置
                        canvasWidth = projectData.canvasWidth;
                        canvasHeight = projectData.canvasHeight;
                        pixelSize = projectData.pixelSize || 20;
                        
                        // 更新UI
                        document.getElementById('canvasWidth').value = canvasWidth;
                        document.getElementById('canvasHeight').value = canvasHeight;
                        document.getElementById('pixelSize').value = pixelSize;
                        
                        // 更新地形颜色
                        if (projectData.terrainColors) {
                            terrainColors = projectData.terrainColors;
                            
                            // 更新颜色选择器
                            for (const terrain in terrainColors) {
                                const picker = document.querySelector(`#${terrain} .color-picker`);
                                if (picker) {
                                    picker.value = terrainColors[terrain];
                                    picker.previousElementSibling.style.backgroundColor = terrainColors[terrain];
                                }
                            }
                        }
                        
                        // 初始化画布
                        initCanvas();
                        
                        // 解码图像数据
                        const imageData = decodeImageData(projectData.encodedImageData);
                        ctx.putImageData(imageData, 0, 0);
                        
                        // 绘制网格
                        if (showGrid) {
                            drawGrid();
                        }
                        
                        showNotification('项目已加载');
                    } catch (error) {
                        console.error('加载项目错误:', error);
                        showNotification('加载项目失败: ' + error.message, true);
                    }
                };
                
                reader.onerror = function() {
                    showNotification('读取文件时发生错误', true);
                };
                
                reader.readAsText(file);
            }
            
            // 事件监听
            canvas.addEventListener('mousedown', function(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;
                drawPixel(x, y);
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (isDrawing) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const x = (e.clientX - rect.left) * scaleX;
                    const y = (e.clientY - rect.top) * scaleY;
                    drawPixel(x, y);
                }
            });
            
            canvas.addEventListener('mouseup', function() {
                isDrawing = false;
            });
            
            canvas.addEventListener('mouseleave', function() {
                isDrawing = false;
            });
            
            // 工具选择
            document.querySelectorAll('.tool').forEach(tool => {
                tool.addEventListener('click', function() {
                    document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    selectedTool = this.id.replace('Tool', '');
                });
            });
            
            // 地形选择
            document.querySelectorAll('.terrain').forEach(terrain => {
                terrain.addEventListener('click', function() {
                    document.querySelectorAll('.terrain').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    selectedTerrain = this.id;
                });
            });
            
            // 颜色选择器
            document.querySelectorAll('.color-picker').forEach(picker => {
                picker.addEventListener('input', function() {
                    const terrainId = this.parentElement.id;
                    terrainColors[terrainId] = this.value;
                    this.previousElementSibling.style.backgroundColor = this.value;
                });
            });
            
            // 上传模式选择
            document.querySelectorAll('.upload-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.upload-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    uploadMode = this.id === 'optionReplace' ? 'replace' : 'overlay';
                });
            });
            
            // 图片上传处理
            document.getElementById('uploadImage').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        uploadedImage = e.target.result;
                        showNotification('图片已加载，点击"处理并应用图片"按钮应用');
                    };
                    
                    reader.onerror = function() {
                        showNotification('读取图片时发生错误', true);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // 处理图片按钮
            document.getElementById('processImageBtn').addEventListener('click', processUploadedImage);
            
            // 模态框按钮事件
            document.getElementById('resizeToImage').addEventListener('click', function() {
                const img = new Image();
                img.onload = function() {
                    applyImageToCanvas(img, true);
                    hideModal();
                };
                img.src = uploadedImage;
            });
            
            document.getElementById('resizeImageToCanvas').addEventListener('click', function() {
                const img = new Image();
                img.onload = function() {
                    applyImageToCanvas(img, false);
                    hideModal();
                };
                img.src = uploadedImage;
            });
            
            document.getElementById('cancelResize').addEventListener('click', function() {
                hideModal();
            });
            
            // 应用画布设置
            document.getElementById('applyCanvasSettings').addEventListener('click', updateCanvasSettings);
            
            // 性能选项切换
            document.getElementById('gridToggle').addEventListener('change', function() {
                showGrid = this.checked;
                initCanvas();
            });
            
            // 保存项目
            document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
            
            // 加载项目
            document.getElementById('loadProject').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    loadProject(this.files[0]);
                }
            });
            
            // 清空画布
            document.getElementById('clearBtn').addEventListener('click', function() {
                if (confirm('确定要清空画布吗？所有未保存的更改将会丢失。')) {
                    initCanvas();
                    showNotification('画布已清空');
                }
            });
            
            // 导出为PNG
            document.getElementById('exportBtn').addEventListener('click', exportPNG);
            
            // 缩放功能
            document.getElementById('zoomInBtn').addEventListener('click', function() {
                if (zoomLevel < 3) {
                    zoomLevel += 0.2;
                    canvas.style.width = (canvasWidth * zoomLevel) + 'px';
                    canvas.style.height = (canvasHeight * zoomLevel) + 'px';
                }
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', function() {
                if (zoomLevel > 0.4) {
                    zoomLevel -= 0.2;
                    canvas.style.width = (canvasWidth * zoomLevel) + 'px';
                    canvas.style.height = (canvasHeight * zoomLevel) + 'px';
                }
            });
            
            document.getElementById('resetViewBtn').addEventListener('click', function() {
                zoomLevel = 1.0;
                canvas.style.width = (canvasWidth * zoomLevel) + 'px';
                canvas.style.height = (canvasHeight * zoomLevel) + 'px';
            });
            
            // 初始化
            initCanvas();
        });
    </script>
</body>
</html>